<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renúncias de Receitas - Governo de Minas Gerais</title>
    
    <!-- ==================== ESTILOS E BIBLIOTECAS ==================== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ==================== VARIÁVEIS DE CORES ==================== */
        :root {
            --primary-dark: #29435A;
            --primary-darker: #0E2F44;
            --accent-red: #B93C42;
            --accent-bright: #DB233F;
            --background-light: #EEEFF5;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --info-blue: #17a2b8;
            --secondary-teal: #20B2AA;
            --hover-blue: #006a82;
        }
        
        /* ==================== ESTILOS GERAIS ==================== */
        html {
            overflow-y: hidden !important;
            overflow-x: hidden !important;
            height: auto !important;
            min-height: auto !important;
            position: relative;
        }

        body {
            font-family: 'Montserrat', Segoe UI, sans-serif;
            background-color: var(--background-light);
            padding-bottom: 15px;
            overflow-y: hidden !important;
            overflow-x: hidden !important;
            min-height: auto !important;
            height: auto !important;
            position: relative;
            margin: 0;
        }

        .main-container, .container {
            height: auto !important;
            min-height: auto !important;
            overflow: visible !important;
            position: relative;
        }

        /* ==================== ESPAÇAMENTO SUPERIOR ==================== */
        .dashboard-top-spacing {
            margin-top: 20px;
        }

        .tab-content, .tab-pane {
            overflow: visible !important;
            height: auto !important;
            min-height: auto !important;
            position: relative;
        }

        .table-container {
            height: auto !important;
            min-height: auto !important;
            overflow: visible !important;
            position: relative;
        }

        .row, .col { overflow: visible !important; }

        .table-fixed-header-container {
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }
        
        /* ==================== HEADER ==================== */
        .main-header {
            background: linear-gradient(135deg, var(--primary-darker) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 12px 0;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid var(--accent-red);
        }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo {
            width: 45px; height: 45px;
            background: linear-gradient(135deg, var(--accent-red), var(--accent-bright));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold;
        }
        .header-title { font-weight: 700; font-size: 18px; margin: 0; }
        
        /* ==================== FILTROS ==================== */
        .filter-container {
            background: white; border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08); padding: 20px;
            margin-bottom: 20px; border-left: 5px solid var(--accent-red);
        }
        .filter-label {
            font-weight: 600; color: var(--primary-dark); margin-bottom: 6px;
            font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .form-control, .form-select {
            border: 2px solid #e9ecef; border-radius: 6px;
            padding: 10px 12px; font-size: 13px; height: 42px;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 2px rgba(185,60,66,0.15);
        }
        
        /* ==================== CARDS DE MÉTRICAS ==================== */
        .metric-card {
            background: white; border-radius: 10px; padding: 20px 15px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06); margin-bottom: 20px;
            border-top: 4px solid var(--accent-red); transition: 0.3s;
            height: 100%; cursor: default;
        }
        .metric-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
        .metric-value { font-size: 24px; font-weight: 700; color: var(--primary-dark); margin: 8px 0; }
        .metric-label { font-size: 12px; color: var(--primary-darker); font-weight: 600; text-transform: uppercase; }
        .metric-year-badge {
            background: var(--accent-red);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }
        
        /* ==================== MENU DE NAVEGAÇÃO ==================== */
        .nav-tabs-container {
            background: white; border-radius: 10px; padding: 12px;
            margin-bottom: 20px; box-shadow: 0 3px 12px rgba(0,0,0,0.06);
            overflow-x: auto; scrollbar-width: thin;
            margin-top: 20px;
        }
        .nav-tabs {
            border: none !important; gap: 4px; flex-wrap: nowrap;
            min-width: max-content; padding-bottom: 5px; margin-bottom: 0 !important;
        }
        .nav-tabs .nav-item { flex-shrink: 0; }
        .nav-tabs .nav-link {
            border: none !important; border-radius: 6px !important;
            padding: 10px 15px !important; font-weight: 600;
            color: var(--primary-dark) !important; font-size: 13px; white-space: nowrap;
            display: inline-flex !important; align-items: center;
            background: none !important;
        }
        .nav-tabs .nav-link:hover {
            background-color: rgba(41,67,90,0.05) !important;
            color: var(--accent-red) !important;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-darker)) !important;
            color: white !important;
        }
        .nav-tabs .nav-link .material-icons { font-size: 18px !important; margin-right: 8px; }
        
        /* ==================== GRÁFICOS ==================== */
        .dashboard-2 {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;
        }
        @media (max-width: 992px) { .dashboard-2 { grid-template-columns: 1fr; } }
        .card-chart {
            background: #fff; border-radius: 14px; border: 1px solid #e9ecef;
            padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            height: 320px; display: flex; flex-direction: column;
        }
        .card-chart h3 {
            margin: 0 0 16px 0; color: #1a1f36; font-size: 16px;
            font-weight: 700; padding-bottom: 12px; border-bottom: 1px solid #f1f3f9;
        }
        .chart-wrapper { flex: 1; position: relative; min-height: 220px; width: 100%; }

        /* ==================== TABELAS ==================== */
        .table-container {
            background: white; border-radius: 10px; overflow: hidden;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06); border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        .table-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-darker));
            color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .table-badge {
            background: var(--accent-red); color: white;
            padding: 4px 12px; border-radius: 15px; font-size: 12px;
        }
        .table thead th {
            background-color: var(--primary-dark) !important;
            color: white !important; font-weight: 600; padding: 12px 10px;
            font-size: 12px; text-transform: uppercase; white-space: nowrap;
            border-left: 1px solid rgba(255,255,255,0.2);
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        .table thead th:first-child { border-left: none; }
        .table thead th:last-child { border-right: none; }
        .table tbody td { padding: 12px 10px; font-size: 13px; border-bottom: 1px solid #f1f1f1; }
        .table tbody tr:hover { background-color: rgba(41,67,90,0.04); }
        .valor-monetario { font-weight: 600; text-align: right; white-space: nowrap; }
        .table-total-row { background-color: #f8f9fa !important; font-weight: 600; }

        /* ==================== TAGS DE SITUAÇÃO ==================== */
        .tag-novas {
            display: inline-block; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            background-color: rgba(185, 60, 66, 0.1);
            color: var(--accent-red);
        }
        .tag-pre {
            display: inline-block; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            background-color: rgba(41, 67, 90, 0.1);
            color: var(--primary-dark);
        }
        .tag-heteronomos {
            display: inline-block; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            background-color: rgba(32, 178, 170, 0.1);
            color: var(--secondary-teal);
        }

        /* ==================== BOTÕES ==================== */
        .btn-primary-custom {
            background: linear-gradient(to right, var(--accent-red), var(--accent-bright));
            border: none; padding: 10px 20px; font-weight: 600; border-radius: 6px;
            font-size: 13px; color: white; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary-custom:hover {
            background: linear-gradient(to right, var(--primary-darker), var(--hover-blue));
            transform: translateY(-1px);
        }
        .btn-secondary-custom {
            background: white; border: 2px solid var(--primary-darker);
            color: var(--primary-dark); padding: 10px 20px; font-weight: 600; border-radius: 6px;
            font-size: 13px; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-secondary-custom:hover {
            background-color: var(--primary-dark); color: white; transform: translateY(-1px);
        }
        .btn-export {
            background: white; border: 2px solid var(--primary-darker);
            color: var(--primary-dark); padding: 8px 15px; border-radius: 6px;
            font-weight: 600; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;
            cursor: pointer; transition: all 0.2s ease; text-decoration: none;
        }
        .btn-export:hover {
            background: var(--primary-dark); color: white; transform: translateY(-1px);
        }
        .btn-share {
            background: white; border: 2px solid var(--primary-darker);
            color: var(--primary-dark); padding: 8px 15px; border-radius: 6px;
            font-weight: 600; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;
            cursor: pointer;
        }
        .btn-share:hover { background: var(--primary-dark); color: white; }

        /* ==================== DROPDOWN DE COMPARTILHAMENTO ==================== */
        .share-dropdown { position: relative; display: inline-block; }
        .share-options {
            position: absolute; bottom: 100%; left: 0; background-color: white;
            min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px; padding: 8px; z-index: 1000; margin-bottom: 5px;
            border: 1px solid #dee2e6; display: none;
        }
        .share-dropdown:hover .share-options { display: block; }
        .share-option {
            display: flex; align-items: center; gap: 10px; padding: 8px 12px;
            text-decoration: none; color: var(--primary-dark); border-radius: 4px;
            transition: all 0.2s ease; cursor: pointer; border: none;
            background: none; width: 100%; font-size: 13px;
        }
        .share-option:hover { background-color: #f8f9fa; color: var(--accent-red); }

        /* ==================== AÇÕES ==================== */
        .actions-container {
            background: white; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
        }
        .export-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .right-aligned-container { display: flex; align-items: center; gap: 15px; margin-left: auto; }

        /* ==================== PAGINAÇÃO ==================== */
        .pagination-container {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-top: 1px solid #dee2e6; background-color: white;
        }
        .pagination-info { font-size: 12px; color: var(--primary-darker); font-weight: 600; }
        .pagination .page-link {
            border: 1px solid #dee2e6; color: var(--primary-dark);
            padding: 6px 10px; font-weight: 600; font-size: 12px;
        }
        .pagination .page-item.active .page-link {
            background-color: var(--primary-dark); border-color: var(--primary-dark); color: white;
        }
        .items-per-page {
            display: flex; align-items: center; gap: 8px; font-size: 12px;
            color: var(--primary-dark); font-weight: 600;
        }
        .items-per-page select {
            border: 2px solid var(--primary-darker); border-radius: 6px;
            padding: 5px 10px; font-size: 12px; width: auto;
        }

        /* ==================== DATA ATUALIZAÇÃO ==================== */
        .data-atualizacao-container {
            display: flex; justify-content: center; margin-bottom: 20px;
            margin-top: 20px;
        }
        .data-atualizacao-box {
            background: white; border-radius: 8px; padding: 8px 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; color: var(--primary-dark); font-weight: 600;
        }
        .data-atualizacao-box i { color: var(--accent-red); }

        /* ==================== CARDS DE DOWNLOAD ==================== */
        .card-stats {
            background: white; border-radius: 10px; padding: 15px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06); margin-bottom: 20px;
            text-align: center; height: 100%; display: flex; flex-direction: column;
        }
        .card-stats h4 { font-size: 16px; font-weight: 700; color: var(--primary-dark); margin: 10px 0; }
        .card-stats p { font-size: 13px; color: #6c757d; margin-bottom: 15px; flex-grow: 1; }
        .card-stats .btn-export { margin-top: auto; }

        /* ==================== AVISOS LEGAIS ==================== */
        .legal-notice {
            background-color: #f8f9fa;
            border-left: 4px solid var(--accent-red);
            padding: 15px;
            font-size: 12px;
            color: var(--primary-darker);
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        .legal-notice strong { color: var(--primary-dark); }

        /* ==================== LOADING ==================== */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: flex;
            justify-content: center; align-items: center; z-index: 9999; display: none;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(19,40,55,0.1); border-radius: 50%;
            border-top-color: var(--accent-red); animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ==================== SUB-TABS ==================== */
        .sub-tabs-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 20px;
        }
        .sub-tabs {
            display: flex;
            gap: 8px;
            border: none;
        }
        .sub-tab-link {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-dark);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sub-tab-link:hover {
            background: rgba(41,67,90,0.1);
            color: var(--accent-red);
        }
        .sub-tab-link.active {
            background: var(--primary-dark);
            color: white;
        }
        .sub-tab-pane {
            display: none;
        }
        .sub-tab-pane.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container main-container dashboard-top-spacing">

        <!-- ==================== MENU DE NAVEGAÇÃO ==================== -->
        <div class="nav-tabs-container">
            <ul class="nav nav-tabs" id="dashboardTabs">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#visao-geral"><i class="material-icons">bar_chart</i>Visão Geral</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#previsao"><i class="material-icons">show_chart</i>Previsão de Renúncias</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#concedidas"><i class="material-icons">receipt</i>Desonerações Concedidas</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#downloads"><i class="material-icons">download</i>Downloads</button></li>
            </ul>
        </div>

        <!-- ==================== DATA ATUALIZAÇÃO ==================== -->
        <div class="data-atualizacao-container">
            <div class="data-atualizacao-box">
                <i class="material-icons">update</i>
                <span>Atualizado em: <span id="data-atualizacao-central">Carregando...</span></span>
            </div>
        </div>

        <div class="tab-content">
            <!-- ========== VISÃO GERAL ========== -->
            <div class="tab-pane fade show active" id="visao-geral">
                <!-- Filtro de Ano para a Visão Geral -->
                <div class="filter-container">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label class="filter-label">Ano de Referência</label>
                            <select class="form-select" id="anoVisaoGeral"></select>
                        </div>
                        <div class="col-md-8">
                            <p class="text-muted mb-0" style="font-size:12px;"><i class="fas fa-info-circle me-1"></i>Selecione o ano para atualizar as métricas e o gráfico de composição</p>
                        </div>
                    </div>
                </div>

                <div class="row mb-4" id="summaryCardsGeral"></div>
                
                <div class="dashboard-2">
                    <div class="card-chart"><h3>Evolução Anual das Renúncias</h3><div class="chart-wrapper"><canvas id="chartEvolucao"></canvas></div></div>
                    <div class="card-chart"><h3>Composição por Tipo <span id="anoComposicao" style="color:var(--accent-red);"></span></h3><div class="chart-wrapper"><canvas id="chartComposicao"></canvas></div></div>
                </div>
                
                <!-- ==================== AVISO LEGAL ==================== -->
                <div class="legal-notice">
                    <strong><i class="fas fa-lock me-2"></i>Sigilo Fiscal - Art. 198 do CTN</strong>
                    <p class="mt-2 mb-0">As informações detalhadas por beneficiário estão protegidas por sigilo fiscal, nos termos do art. 198 do Código Tributário Nacional – CTN (Lei nº 5.172/1966), o qual veda expressamente a divulgação de dados obtidos pela Administração Tributária.</p>
                    <p class="mb-0 mt-1"><strong>Art. 198</strong> — Sem prejuízo das sanções previstas na legislação criminal, é proibida a divulgação, por parte da Fazenda Pública ou de seus servidores, de informações obtidas em razão do ofício sobre a situação econômica ou financeira do sujeito passivo ou de terceiros, bem como sobre a natureza e o estado de seus negócios ou atividades.</p>
                    <p class="mt-2 mb-0">Dessa forma, não é permitido disponibilizar dados individualizados, garantindo a proteção das informações sensíveis e o cumprimento das normas legais de sigilo fiscal. Os valores apresentados referem-se a renúncias e desonerações, tratadas de maneira agregada, sem distinção por beneficiário.</p>
                </div>
                
                <!-- ==================== METADADOS ==================== -->
                <div class="filter-container">
                    <h5 style="color:var(--primary-dark);"><i class="fas fa-info-circle me-2"></i>Metadados e Notas Técnicas</h5>
                    <div style="font-size:12px; max-height:200px; overflow-y:auto; background:#f8f9fa; padding:15px; border-radius:5px;">
                        <p><strong>Fonte:</strong> Dados do Armazém Cognos e SAS - SAIF/DIEF; SICAF/MG - SUCRED</p>
                        <p><strong>Elaboração:</strong> DIEF/SAIF/SEF-MG</p>
                        <p><strong>Notas:</strong> 1 - Para a quantificação das renúncias fiscais do ICMS formalizadas em regimes especiais, a SEF/MG agrega e consolida por núcleo de CNPJ, os dados informados pelos contribuintes na DAPI - Declaração de Apuração do ICMS, Portaria SRE-117/2013, modalidade de autolançamento do imposto, e complementa eventualmente com os dados dos demais documentos eletrônicos emitidos pelos mesmos. Essas informações estão sujeitas à revisão fiscal no prazo decadencial de 5 anos.</p>
                        <p>2 - A SEF/MG, na eventual concessão de regime especial de tratamento tributário setorial que possa ser caracterizado como uma nova renúncia de receita de ICMS, adota o dispositivo de salvaguarda da arrecadação tributária, como medida de compensação de renúncia fiscal, consistente na aceitação pelo contribuinte, do compromisso de efetuar um recolhimento mínimo nos exercícios seguintes, correspondente ao valor do ICMS recolhido no exercício fiscal anterior, a título de operação própria e substituição tributária, corrigido pela variação acumulada do IPCA, divulgado pelo IBGE.</p>
                        <p>3 - A critério da SEF/MG, alternativamente ao exercício fiscal anterior, a comparação poderá ser correspondente ao valor do ICMS recolhido nos dozes meses anteriores ao mês de início de fruição do tratamento tributário, a título de operação própria e substituição tributária, corrigido pela variação acumulada do IPCA, divulgado pelo IBGE.</p>
                        <p>4 - No caso de contribuinte com saldo credor no exercício anterior ou com a carga efetiva inferior ao percentual a ser concedido mediante regime especial, bem como em relação ao contribuinte que está iniciando as atividades no Estado, ou seja, investimento novo, a comparação será feita entre o valor recolhido no segundo período de 12 meses após o início de fruição do tratamento tributário e o valor recolhido nos primeiros 12 meses após o início de fruição deste, corrigido pela variação acumulada do IPCA, divulgado pelo IBGE.</p>
                        <p>5 - Como medida de compensação será utilizado o produto da arrecadação do ICMS relativo ao segmento de combustíveis em Minas Gerais em razão da majoração dos valores de Ad rem da gasolina e do etanol anidro a ela adicionado, do óleo diesel e biodiesel adicionado, e de GLP, inclusive o derivado de gás natural, introduzido pela Lei Complementar nº 192/22 e Convênios ICMS nº 112 e nº 113/2025 com os novos valores de Ad rem com vigência a partir de 01/01/2026. A fundamentação legal é no sentido de que não serão afetadas as metas de resultados fiscais do setor, nos termos do inciso I, art. 14 da Lei Complementar nº 101/2000.</p>
                    </div>
                </div>
            </div>

            <!-- ========== PREVISÃO DE RENÚNCIAS ========== -->
            <div class="tab-pane fade" id="previsao">
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="filter-label">Ano</label>
                            <select class="form-select" id="anoPrevisao"></select>
                        </div>
                    </div>
                </div>

                <!-- Sub-tabs para Previsão -->
                <div class="sub-tabs-container">
                    <div class="sub-tabs">
                        <button class="sub-tab-link active" data-sub-tab="previsao-novas">Renúncias Novas</button>
                        <button class="sub-tab-link" data-sub-tab="previsao-pre">Renúncias Pré-existentes</button>
                    </div>
                </div>

                <!-- Painel Renúncias Novas -->
                <div class="sub-tab-pane active" id="previsao-novas">
                    <div class="actions-container">
                        <div class="export-buttons">
                            <button class="btn-export" id="exportCSVPrevisaoNovas"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                            <div class="share-dropdown">
                                <button class="btn-share"><i class="fas fa-share-alt"></i> Compartilhar</button>
                                <div class="share-options">
                                    <button class="share-option" onclick="copiarLink()"><i class="fas fa-link"></i> Copiar Link</button>
                                    <button class="share-option" onclick="compartilharFacebook(event)"><i class="fab fa-facebook-f"></i> Facebook</button>
                                    <button class="share-option" onclick="compartilharTwitter(event)"><i class="fab fa-twitter"></i> Twitter</button>
                                    <button class="share-option" onclick="compartilharLinkedIn(event)"><i class="fab fa-linkedin-in"></i> LinkedIn</button>
                                    <button class="share-option" onclick="compartilharWhatsApp(event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                                </div>
                            </div>
                        </div>
                        <div class="right-aligned-container">
                            <span class="table-badge" id="countPrevisaoNovas">0 registros</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-fixed-header-container">
                            <table class="table" id="tabelaPrevisaoNovas">
                                <thead>
                                    <tr>
                                        <th>Regional</th>
                                        <th>Tributo</th>
                                        <th>Modalidade</th>
                                        <th>Setor/Programa</th>
                                        <th class="valor-monetario">Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyPrevisaoNovas"></tbody>
                                <tfoot id="tfootPrevisaoNovas"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Painel Renúncias Pré-existentes -->
                <div class="sub-tab-pane" id="previsao-pre">
                    <div class="actions-container">
                        <div class="export-buttons">
                            <button class="btn-export" id="exportCSVPrevisaoPre"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                            <div class="share-dropdown">
                                <button class="btn-share"><i class="fas fa-share-alt"></i> Compartilhar</button>
                                <div class="share-options">
                                    <button class="share-option" onclick="copiarLink()"><i class="fas fa-link"></i> Copiar Link</button>
                                    <button class="share-option" onclick="compartilharFacebook(event)"><i class="fab fa-facebook-f"></i> Facebook</button>
                                    <button class="share-option" onclick="compartilharTwitter(event)"><i class="fab fa-twitter"></i> Twitter</button>
                                    <button class="share-option" onclick="compartilharLinkedIn(event)"><i class="fab fa-linkedin-in"></i> LinkedIn</button>
                                    <button class="share-option" onclick="compartilharWhatsApp(event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                                </div>
                            </div>
                        </div>
                        <div class="right-aligned-container">
                            <span class="table-badge" id="countPrevisaoPre">0 registros</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-fixed-header-container">
                            <table class="table" id="tabelaPrevisaoPre">
                                <thead>
                                    <tr>
                                        <th>Regional</th>
                                        <th class="valor-monetario">ICMS Isenção</th>
                                        <th class="valor-monetario">ICMS Redução Base</th>
                                        <th class="valor-monetario">ICMS Redução Alíquota</th>
                                        <th class="valor-monetario">ICMS Crédito Presumido</th>
                                        <th class="valor-monetario">ICMS Incentivo Cultura</th>
                                        <th class="valor-monetario">ICMS SUFRAMA</th>
                                        <th class="valor-monetario">ICMS Anistia</th>
                                        <th class="valor-monetario">IPVA Isenção</th>
                                        <th class="valor-monetario">IPVA Redução Alíquota</th>
                                        <th class="valor-monetario">ITCD Anistia</th>
                                        <th class="valor-monetario">Taxa Anistia</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyPrevisaoPre"></tbody>
                                <tfoot id="tfootPrevisaoPre"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RENÚNCIAS CONCEDIDAS ========== -->
            <div class="tab-pane fade" id="concedidas">
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-3"><label class="filter-label">Ano</label><select class="form-select" id="anoConcedidas"></select></div>
                        <div class="col-md-3"><label class="filter-label">Tributo</label><select class="form-select" id="tributoConcedidas"></select></div>
                        <div class="col-md-3"><label class="filter-label">Tipo</label><select class="form-select" id="tipoConcedidas"><option value="">Todos</option><option value="NOVAS">Novas</option><option value="PRE-EXISTENTES">Pré-existentes</option><option value="BENEFÍCIOS FISCAIS HETERÔNOMOS">Heterônomos</option></select></div>
                    </div>
                </div>
                <div class="actions-container">
                    <div class="export-buttons">
                        <button class="btn-export" id="exportCSVConcedidas"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                        <div class="share-dropdown">
                            <button class="btn-share"><i class="fas fa-share-alt"></i> Compartilhar</button>
                            <div class="share-options">
                                <button class="share-option" onclick="copiarLink()"><i class="fas fa-link"></i> Copiar Link</button>
                                <button class="share-option" onclick="compartilharFacebook(event)"><i class="fab fa-facebook-f"></i> Facebook</button>
                                <button class="share-option" onclick="compartilharTwitter(event)"><i class="fab fa-twitter"></i> Twitter</button>
                                <button class="share-option" onclick="compartilharLinkedIn(event)"><i class="fab fa-linkedin-in"></i> LinkedIn</button>
                                <button class="share-option" onclick="compartilharWhatsApp(event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                            </div>
                        </div>
                    </div>
                    <div class="right-aligned-container">
                        <div class="items-per-page"><span>Itens:</span><select id="itemsPerPageConcedidas"><option value="10">10</option><option value="25">25</option><option value="50" selected>50</option></select></div>
                        <span class="table-badge" id="countConcedidas">0 registros</span>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-fixed-header-container">
                        <table class="table" id="tabelaConcedidas">
                            <thead><tr><th>Ano</th><th>Tributo</th><th>Modalidade</th><th>Tipo</th><th class="valor-monetario">Valor (R$)</th></tr></thead>
                            <tbody id="tbodyConcedidas"></tbody>
                            <tfoot id="tfootConcedidas"></tfoot>
                        </table>
                    </div>
                    <div class="pagination-container">
                        <div class="pagination-info" id="paginationInfoConcedidas"></div>
                        <nav><ul class="pagination" id="paginationConcedidas"></ul></nav>
                    </div>
                </div>
            </div>

            <!-- ========== DOWNLOADS ========== -->
            <div class="tab-pane fade" id="downloads">
                <div class="filter-container">
                    <h4 style="color:var(--primary-dark);"><i class="fas fa-download me-2"></i>Baixar Conjuntos de Dados</h4>
                    <div class="row mb-4" id="downloadsGrid"></div>
                    
                    <h4 style="color:var(--primary-dark); margin-top: 30px;"><i class="fas fa-link me-2"></i>Links Institucionais</h4>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card-stats">
                                <i class="fab fa-github fa-3x mb-3" style="color: var(--primary-dark);"></i>
                                <h4>Repositório GitHub</h4>
                                <p>Acesse o código-fonte, documentação e histórico de versões dos dados.</p>
                                <a href="https://github.com/transparencia-mg/renuncias" target="_blank" class="btn-export w-100"><i class="fab fa-github me-2"></i> Acessar Repositório</a>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card-stats">
                                <i class="fas fa-external-link-alt fa-3x mb-3" style="color: var(--primary-dark);"></i>
                                <h4>Portal de Dados Abertos</h4>
                                <p>Explore outros conjuntos de dados do Governo de Minas Gerais.</p>
                                <a href="https://dados.mg.gov.br/" target="_blank" class="btn-export w-100"><i class="fas fa-external-link-alt me-2"></i> Acessar Portal</a>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card-stats">
                                <i class="fas fa-university fa-3x mb-3" style="color: var(--primary-dark);"></i>
                                <h4>Secretaria da Fazenda</h4>
                                <p>Informações oficiais sobre renúncias fiscais no site da SEF/MG.</p>
                                <a href="https://www.fazenda.mg.gov.br/transparencia/renuncias/" target="_blank" class="btn-export w-100"><i class="fas fa-external-link-alt me-2"></i> Acessar SEFAZ</a>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="color:var(--primary-dark); margin-top: 30px;"><i class="fas fa-gavel me-2"></i>Legislação</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card-stats">
                                <i class="fas fa-book fa-3x mb-3" style="color: var(--primary-dark);"></i>
                                <h4>Legislação Tributária</h4>
                                <p>Acesse o portal completo da legislação tributária de Minas Gerais.</p>
                                <a href="https://www.fazenda.mg.gov.br/empresas/legislacao_tributaria/index.html" target="_blank" class="btn-export w-100"><i class="fas fa-external-link-alt me-2"></i> Acessar Legislação</a>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card-stats">
                                <i class="fas fa-file-alt fa-3x mb-3" style="color: var(--primary-dark);"></i>
                                <h4>Regimes Especiais Automatizados</h4>
                                <p>Resolução nº 5.424/2020 - Procedimentos para regimes especiais padronizados.</p>
                                <a href="https://www.fazenda.mg.gov.br/empresas/legislacao_tributaria/resolucoes/2020/rr5424_2020.html" target="_blank" class="btn-export w-100"><i class="fas fa-external-link-alt me-2"></i> Acessar Resolução</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ==================== AVISO LEGAL ADICIONAL ==================== -->
                    <div class="legal-notice mt-4">
                        <strong><i class="fas fa-lock me-2"></i>Sigilo Fiscal - Art. 198 do CTN</strong>
                        <p class="mt-2 mb-0">As informações detalhadas por beneficiário estão protegidas por sigilo fiscal, nos termos do art. 198 do Código Tributário Nacional – CTN (Lei nº 5.172/1966). Dessa forma, não é permitido disponibilizar dados individualizados, garantindo a proteção das informações sensíveis e o cumprimento das normas legais de sigilo fiscal.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // ==================== SCROLL E IFRAME ====================
        function removeAllScrollIssues() {
            const elements = [document.body, document.documentElement, document.querySelector('.main-container'), document.querySelector('.container'), document.querySelector('.tab-content'), ...document.querySelectorAll('.tab-pane'), ...document.querySelectorAll('.table-container'), ...document.querySelectorAll('.row'), ...document.querySelectorAll('.col')];
            elements.forEach(el => { if (el?.style) { el.style.overflowY = 'visible'; el.style.overflowX = 'visible'; el.style.overflow = 'visible'; } });
            document.documentElement.style.height = 'auto'; document.body.style.height = 'auto';
        }
        function iframeUpdateHeight() {
            document.body.style.display = 'none'; document.body.offsetHeight; document.body.style.display = '';
            const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight) + 10;
            try { window.parent.postMessage({ iframeHeight: h }, '*'); } catch (e) {}
            return h;
        }

        // ==================== COMPARTILHAMENTO ====================
        window.copiarLink = function() {
            navigator.clipboard.writeText(window.location.href).then(() => alert('Link copiado!'));
            document.querySelectorAll('.share-options').forEach(o => o.classList.remove('show'));
        };
        window.compartilharFacebook = (e) => { e.preventDefault(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank'); };
        window.compartilharTwitter = (e) => { e.preventDefault(); window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent('Renúncias de Receitas - Governo de Minas Gerais')}`, '_blank'); };
        window.compartilharLinkedIn = (e) => { e.preventDefault(); window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`, '_blank'); };
        window.compartilharWhatsApp = (e) => { e.preventDefault(); window.open(`https://wa.me/?text=${encodeURIComponent('Renúncias de Receitas - Governo de Minas Gerais: ' + window.location.href)}`, '_blank'); };
        document.addEventListener('click', (e) => { if (!e.target.closest('.share-dropdown')) document.querySelectorAll('.share-options').forEach(o => o.classList.remove('show')); });

        // ==================== CONFIGURAÇÕES ====================
        const GITHUB_BASE = 'https://raw.githubusercontent.com/transparencia-mg/renuncias/main/dataset/data/';
        const ARQUIVOS = {
            concedidas: 'renuncias_concedidas.csv',
            previsaoNovas: 'previsao_renuncias_novas.csv',
            previsaoPre: 'previsao_renuncias_pre_existentes.csv'
        };

        let dadosConcedidas = [];
        let dadosPrevisaoNovas = [];
        let dadosPrevisaoPre = [];

        let filteredConcedidas = [];
        let currentPage = { concedidas: 1 };
        let itemsPerPage = { concedidas: 50 };
        let charts = {};
        let anoVisaoGeralSelecionado = null;

        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        function updateDataAtualizacao() { document.getElementById('data-atualizacao-central').textContent = new Date().toLocaleString('pt-BR'); }
        function parseValor(v) { return parseFloat(String(v || '0').replace(/\./g, '').replace(',', '.')) || 0; }
        function formatarMoeda(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }

        // ==================== CARREGAMENTO ====================
        async function carregarTodosDados() {
            showLoading(true);
            try {
                // Concedidas
                const resConc = await fetch(GITHUB_BASE + ARQUIVOS.concedidas);
                const txtConc = await resConc.text();
                Papa.parse(txtConc, { header: true, delimiter: ';', skipEmptyLines: true, complete: (r) => {
                    dadosConcedidas = r.data.map(d => ({
                        ano: d.ano,
                        tipo: d.tipo,
                        tributo: d.tributo,
                        modalidade: d.modalidade,
                        norma: d.norma_autorizada,
                        valor: parseValor(d.montante_perdas)
                    })).filter(d => d.ano && d.valor > 0);
                }});

                // Previsão Novas
                const resPrevN = await fetch(GITHUB_BASE + ARQUIVOS.previsaoNovas);
                const txtPrevN = await resPrevN.text();
                Papa.parse(txtPrevN, { header: true, delimiter: ';', skipEmptyLines: true, complete: (r) => {
                    dadosPrevisaoNovas = r.data.map(d => ({
                        ano: parseInt(d.ano),
                        regionalizacao: d.regionalizacao,
                        tributo: d.tributo,
                        modalidade: d.modalidade,
                        setor: d.setor_programa_beneficiario,
                        valor: parseValor(d.valor)
                    })).filter(d => d.ano && d.valor > 0);
                }});

                // Previsão Pré-existentes
                const resPrevP = await fetch(GITHUB_BASE + ARQUIVOS.previsaoPre);
                const txtPrevP = await resPrevP.text();
                Papa.parse(txtPrevP, { header: true, delimiter: ';', skipEmptyLines: true, complete: (r) => {
                    dadosPrevisaoPre = r.data.map(d => ({
                        ano: parseInt(d.ano),
                        tipo: d.tipo,
                        regionalizacao: d.regionalizacao,
                        icms_isencao: parseValor(d.icms_isencao),
                        icms_reducao_base: parseValor(d.icms_reducao_base_calculo),
                        icms_reducao_aliquota: parseValor(d.icms_reducao_aliquota),
                        icms_credito: parseValor(d.icms_credito_presumido),
                        icms_incentivo_cultura: parseValor(d.icms_incentivo_cultura_esporte),
                        icms_suframa: parseValor(d.icms_suframa),
                        icms_anistia: parseValor(d.icms_anistia),
                        ipva_isencao: parseValor(d.ipva_isencao),
                        ipva_reducao_aliquota: parseValor(d.ipva_reducao_aliquota),
                        itcd_anistia: parseValor(d.anistia_itcd),
                        taxa_anistia: parseValor(d.anistia_taxa)
                    })).filter(d => d.ano);
                }});

                filteredConcedidas = [...dadosConcedidas];
                preencherFiltros();
                
                // Define o ano mais recente como padrão para visão geral
                const anos = [...new Set(dadosConcedidas.map(d => d.ano))].sort().reverse();
                anoVisaoGeralSelecionado = anos[0] || null;
                if (document.getElementById('anoVisaoGeral')) {
                    document.getElementById('anoVisaoGeral').value = anoVisaoGeralSelecionado;
                }
                
                atualizarTudo();
                preencherDownloads();
                initSubTabs();
            } catch (e) { console.error(e); } finally { showLoading(false); iframeUpdateHeight(); }
        }

        // ==================== SUB-TABS ====================
        function initSubTabs() {
            document.querySelectorAll('.sub-tab-link').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Remove active de todos
                    document.querySelectorAll('.sub-tab-link').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.sub-tab-pane').forEach(p => p.classList.remove('active'));
                    
                    // Ativa o clicado
                    btn.classList.add('active');
                    const target = btn.getAttribute('data-sub-tab');
                    document.getElementById(target).classList.add('active');
                    
                    // Atualiza as tabelas
                    if (target === 'previsao-novas') {
                        preencherTabelaPrevisaoNovas();
                    } else {
                        preencherTabelaPrevisaoPre();
                    }
                    iframeUpdateHeight();
                });
            });
        }

        // ==================== INTERFACE ====================
        function atualizarTudo() {
            atualizarCardsVisaoGeral();
            atualizarGraficos();
            atualizarTabelaConcedidas();
            preencherTabelaPrevisaoNovas();
            preencherTabelaPrevisaoPre();
        }

        function atualizarCardsVisaoGeral() {
            if (!anoVisaoGeralSelecionado) return;
            
            const totalRecente = dadosConcedidas.filter(d => d.ano == anoVisaoGeralSelecionado).reduce((s, d) => s + d.valor, 0);
            const totalNovas = dadosConcedidas.filter(d => d.ano == anoVisaoGeralSelecionado && d.tipo === 'NOVAS').reduce((s, d) => s + d.valor, 0);
            const totalPre = dadosConcedidas.filter(d => d.ano == anoVisaoGeralSelecionado && d.tipo === 'PRE-EXISTENTES').reduce((s, d) => s + d.valor, 0);
            const totalHetero = dadosConcedidas.filter(d => d.ano == anoVisaoGeralSelecionado && d.tipo === 'BENEFÍCIOS FISCAIS HETERÔNOMOS').reduce((s, d) => s + d.valor, 0);
            
            document.getElementById('summaryCardsGeral').innerHTML = `
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Total Concedido <span class="metric-year-badge">${anoVisaoGeralSelecionado}</span></div>
                        <div class="metric-value">${formatarMoeda(totalRecente)}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Renúncias Novas <span class="metric-year-badge">${anoVisaoGeralSelecionado}</span></div>
                        <div class="metric-value">${formatarMoeda(totalNovas)}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Pré-existentes <span class="metric-year-badge">${anoVisaoGeralSelecionado}</span></div>
                        <div class="metric-value">${formatarMoeda(totalPre)}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Heterônomos <span class="metric-year-badge">${anoVisaoGeralSelecionado}</span></div>
                        <div class="metric-value">${formatarMoeda(totalHetero)}</div>
                    </div>
                </div>
            `;
        }

        function atualizarGraficos() {
            const ctxEvol = document.getElementById('chartEvolucao')?.getContext('2d');
            if (ctxEvol && dadosConcedidas.length) {
                if (charts.evol) charts.evol.destroy();
                const anos = [...new Set(dadosConcedidas.map(d => d.ano))].sort();
                const totais = anos.map(a => dadosConcedidas.filter(d => d.ano == a).reduce((s, d) => s + d.valor, 0));
                charts.evol = new Chart(ctxEvol, { 
                    type: 'line', 
                    data: { 
                        labels: anos, 
                        datasets: [{ 
                            data: totais, 
                            borderColor: '#29435A', 
                            backgroundColor: '#29435A33', 
                            fill: true,
                            tension: 0.1
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => 'R$ ' + ctx.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: (value) => 'R$ ' + (value/1e6).toFixed(1) + 'M'
                                }
                            }
                        }
                    } 
                });
            }
            
            atualizarGraficoComposicao();
        }

        function atualizarGraficoComposicao() {
            const ctxComp = document.getElementById('chartComposicao')?.getContext('2d');
            if (ctxComp && dadosConcedidas.length && anoVisaoGeralSelecionado) {
                if (charts.comp) charts.comp.destroy();
                
                document.getElementById('anoComposicao').textContent = `- ${anoVisaoGeralSelecionado}`;
                
                const novas = dadosConcedidas.filter(d => d.ano == anoVisaoGeralSelecionado && d.tipo === 'NOVAS').reduce((s, d) => s + d.valor, 0);
                const pre = dadosConcedidas.filter(d => d.ano == anoVisaoGeralSelecionado && d.tipo === 'PRE-EXISTENTES').reduce((s, d) => s + d.valor, 0);
                const hetero = dadosConcedidas.filter(d => d.ano == anoVisaoGeralSelecionado && d.tipo === 'BENEFÍCIOS FISCAIS HETERÔNOMOS').reduce((s, d) => s + d.valor, 0);
                
                charts.comp = new Chart(ctxComp, { 
                    type: 'doughnut', 
                    data: { 
                        labels: ['Novas', 'Pré-existentes', 'Heterônomos'], 
                        datasets: [{ 
                            data: [novas, pre, hetero], 
                            backgroundColor: ['#B93C42', '#29435A', '#20B2AA'],
                            borderWidth: 0
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const total = ctx.dataset.data.reduce((a,b) => a + b, 0);
                                        const percentage = ((ctx.raw / total) * 100).toFixed(1);
                                        return `${ctx.label}: R$ ${ctx.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                                    }
                                }
                            }
                        } 
                    } 
                });
            }
        }

        // ==================== TABELA PREVISÃO NOVAS ====================
        function preencherTabelaPrevisaoNovas() {
            const ano = document.getElementById('anoPrevisao')?.value;
            let dados = dadosPrevisaoNovas.filter(d => !ano || d.ano == ano);

            const tbody = document.getElementById('tbodyPrevisaoNovas');
            const tfoot = document.getElementById('tfootPrevisaoNovas');
            document.getElementById('countPrevisaoNovas').textContent = `${dados.length} registros`;

            tbody.innerHTML = dados.map(d => `<tr>
                <td>${d.regionalizacao}</td>
                <td>${d.tributo}</td>
                <td>${d.modalidade}</td>
                <td>${d.setor || '-'}</td>
                <td class="valor-monetario">${formatarMoeda(d.valor)}</td>
            </tr>`).join('');

            const total = dados.reduce((s, d) => s + (d.valor || 0), 0);
            tfoot.innerHTML = `<tr class="table-total-row">
                <td colspan="4" class="text-end">TOTAL</td>
                <td class="valor-monetario">${formatarMoeda(total)}</td>
            </tr>`;
        }

        // ==================== TABELA PREVISÃO PRÉ-EXISTENTES ====================
        function preencherTabelaPrevisaoPre() {
            const ano = document.getElementById('anoPrevisao')?.value;
            let dados = dadosPrevisaoPre.filter(d => !ano || d.ano == ano);

            const tbody = document.getElementById('tbodyPrevisaoPre');
            const tfoot = document.getElementById('tfootPrevisaoPre');
            document.getElementById('countPrevisaoPre').textContent = `${dados.length} registros`;

            tbody.innerHTML = dados.map(d => `<tr>
                <td>${d.regionalizacao}</td>
                <td class="valor-monetario">${formatarMoeda(d.icms_isencao)}</td>
                <td class="valor-monetario">${formatarMoeda(d.icms_reducao_base)}</td>
                <td class="valor-monetario">${formatarMoeda(d.icms_reducao_aliquota)}</td>
                <td class="valor-monetario">${formatarMoeda(d.icms_credito)}</td>
                <td class="valor-monetario">${formatarMoeda(d.icms_incentivo_cultura)}</td>
                <td class="valor-monetario">${formatarMoeda(d.icms_suframa)}</td>
                <td class="valor-monetario">${formatarMoeda(d.icms_anistia)}</td>
                <td class="valor-monetario">${formatarMoeda(d.ipva_isencao)}</td>
                <td class="valor-monetario">${formatarMoeda(d.ipva_reducao_aliquota)}</td>
                <td class="valor-monetario">${formatarMoeda(d.itcd_anistia)}</td>
                <td class="valor-monetario">${formatarMoeda(d.taxa_anistia)}</td>
            </tr>`).join('');

            const totais = dados.reduce((s, d) => { 
                s.i1 += d.icms_isencao; 
                s.i2 += d.icms_reducao_base;
                s.i3 += d.icms_reducao_aliquota;
                s.i4 += d.icms_credito;
                s.i5 += d.icms_incentivo_cultura;
                s.i6 += d.icms_suframa;
                s.i7 += d.icms_anistia;
                s.i8 += d.ipva_isencao;
                s.i9 += d.ipva_reducao_aliquota;
                s.i10 += d.itcd_anistia;
                s.i11 += d.taxa_anistia;
                return s; 
            }, {i1:0,i2:0,i3:0,i4:0,i5:0,i6:0,i7:0,i8:0,i9:0,i10:0,i11:0});

            tfoot.innerHTML = `<tr class="table-total-row">
                <td>TOTAL</td>
                <td class="valor-monetario">${formatarMoeda(totais.i1)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i2)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i3)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i4)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i5)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i6)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i7)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i8)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i9)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i10)}</td>
                <td class="valor-monetario">${formatarMoeda(totais.i11)}</td>
            </tr>`;
        }

        // ==================== TABELA CONCEDIDAS ====================
        function atualizarTabelaConcedidas() {
            const total = filteredConcedidas.length;
            const start = (currentPage.concedidas - 1) * itemsPerPage.concedidas;
            const end = Math.min(start + itemsPerPage.concedidas, total);
            const currentData = filteredConcedidas.slice(start, end);

            document.getElementById('tbodyConcedidas').innerHTML = currentData.map(d => `<tr>
                <td>${d.ano}</td><td>${d.tributo}</td><td>${d.modalidade}</td>
                <td><span class="${d.tipo === 'NOVAS' ? 'tag-novas' : d.tipo === 'PRE-EXISTENTES' ? 'tag-pre' : 'tag-heteronomos'}">${d.tipo}</span></td>
                <td class="valor-monetario">${formatarMoeda(d.valor)}</td>
            </tr>`).join('');

            const totalValor = filteredConcedidas.reduce((s, d) => s + d.valor, 0);
            document.getElementById('tfootConcedidas').innerHTML = `<tr class="table-total-row"><td colspan="4" class="text-end">TOTAL:</td><td class="valor-monetario">${formatarMoeda(totalValor)}</td></tr>`;
            document.getElementById('countConcedidas').textContent = `${total} registros`;
            document.getElementById('paginationInfoConcedidas').textContent = `Mostrando ${start+1}-${end} de ${total}`;
            atualizarPaginacao(Math.ceil(total / itemsPerPage.concedidas));
        }

        function atualizarPaginacao(totalPages) {
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${i === currentPage.concedidas ? 'active' : ''}"><a class="page-link" href="#" onclick="mudarPagina(${i})">${i}</a></li>`;
            }
            document.getElementById('paginationConcedidas').innerHTML = html;
        }
        window.mudarPagina = (page) => { currentPage.concedidas = page; atualizarTabelaConcedidas(); iframeUpdateHeight(); };

        // ==================== FILTROS ====================
        function preencherFiltros() {
            const anosConc = [...new Set(dadosConcedidas.map(d => d.ano))].sort().reverse();
            document.getElementById('anoConcedidas').innerHTML = '<option value="">Todos</option>' + anosConc.map(a => `<option value="${a}">${a}</option>`).join('');
            const tributos = [...new Set(dadosConcedidas.map(d => d.tributo))].sort();
            document.getElementById('tributoConcedidas').innerHTML = '<option value="">Todos</option>' + tributos.map(t => `<option value="${t}">${t}</option>`).join('');
            
            const anosPrev = [...new Set([...dadosPrevisaoNovas.map(d => d.ano), ...dadosPrevisaoPre.map(d => d.ano)])].sort().reverse();
            document.getElementById('anoPrevisao').innerHTML = '<option value="">Todos</option>' + anosPrev.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Filtro da Visão Geral
            document.getElementById('anoVisaoGeral').innerHTML = anosConc.map(a => `<option value="${a}">${a}</option>`).join('');

            // Event Listeners
            document.getElementById('anoPrevisao').addEventListener('change', () => {
                // Verifica qual sub-tab está ativa e atualiza a tabela correspondente
                if (document.getElementById('previsao-novas').classList.contains('active')) {
                    preencherTabelaPrevisaoNovas();
                } else {
                    preencherTabelaPrevisaoPre();
                }
            });
            
            document.getElementById('anoVisaoGeral').addEventListener('change', (e) => {
                anoVisaoGeralSelecionado = e.target.value;
                atualizarCardsVisaoGeral();
                atualizarGraficoComposicao();
            });
            
            document.getElementById('anoConcedidas').addEventListener('change', filtrarConcedidas);
            document.getElementById('tributoConcedidas').addEventListener('change', filtrarConcedidas);
            document.getElementById('tipoConcedidas').addEventListener('change', filtrarConcedidas);
            document.getElementById('itemsPerPageConcedidas').addEventListener('change', (e) => { 
                itemsPerPage.concedidas = parseInt(e.target.value); 
                currentPage.concedidas = 1; 
                atualizarTabelaConcedidas(); 
            });
        }

        function filtrarConcedidas() {
            const ano = document.getElementById('anoConcedidas').value;
            const tributo = document.getElementById('tributoConcedidas').value;
            const tipo = document.getElementById('tipoConcedidas').value;
            filteredConcedidas = dadosConcedidas.filter(d => (!ano || d.ano == ano) && (!tributo || d.tributo === tributo) && (!tipo || d.tipo === tipo));
            currentPage.concedidas = 1;
            atualizarTabelaConcedidas();
            iframeUpdateHeight();
        }

        // ==================== DOWNLOADS ====================
        function preencherDownloads() {
            document.getElementById('downloadsGrid').innerHTML = `
                <div class="col-md-4 mb-3"><div class="card-stats"><i class="fas fa-file-csv fa-3x"></i><h5>renuncias_concedidas.csv</h5><p>Registros consolidados de renúncias concedidas por ano, tributo e modalidade.</p><a href="${GITHUB_BASE}renuncias_concedidas.csv" target="_blank" class="btn-export w-100"><i class="fas fa-download"></i> Baixar CSV</a></div></div>
                <div class="col-md-4 mb-3"><div class="card-stats"><i class="fas fa-file-csv fa-3x"></i><h5>previsao_renuncias_novas.csv</h5><p>Previsões de novas renúncias com detalhamento por regional, tributo, modalidade e setor.</p><a href="${GITHUB_BASE}previsao_renuncias_novas.csv" target="_blank" class="btn-export w-100"><i class="fas fa-download"></i> Baixar CSV</a></div></div>
                <div class="col-md-4 mb-3"><div class="card-stats"><i class="fas fa-file-csv fa-3x"></i><h5>previsao_renuncias_pre_existentes.csv</h5><p>Previsões de renúncias pré-existentes com detalhamento regional por tipo de benefício.</p><a href="${GITHUB_BASE}previsao_renuncias_pre_existentes.csv" target="_blank" class="btn-export w-100"><i class="fas fa-download"></i> Baixar CSV</a></div></div>
            `;
        }

        // ==================== EXPORTAÇÃO ====================
        document.getElementById('exportCSVConcedidas')?.addEventListener('click', () => { 
            saveAs(new Blob(["\ufeff" + Papa.unparse(filteredConcedidas)], {type:"text/csv"}), "renuncias_concedidas_filtradas.csv"); 
        });
        
        document.getElementById('exportCSVPrevisaoNovas')?.addEventListener('click', () => {
            const ano = document.getElementById('anoPrevisao')?.value;
            let dados = dadosPrevisaoNovas.filter(d => !ano || d.ano == ano);
            saveAs(new Blob(["\ufeff" + Papa.unparse(dados)], {type:"text/csv"}), "previsao_renuncias_novas.csv");
        });

        document.getElementById('exportCSVPrevisaoPre')?.addEventListener('click', () => {
            const ano = document.getElementById('anoPrevisao')?.value;
            let dados = dadosPrevisaoPre.filter(d => !ano || d.ano == ano);
            saveAs(new Blob(["\ufeff" + Papa.unparse(dados)], {type:"text/csv"}), "previsao_renuncias_pre_existentes.csv");
        });

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', () => {
            removeAllScrollIssues();
            carregarTodosDados();
            updateDataAtualizacao();
            setInterval(updateDataAtualizacao, 60000);
            setInterval(iframeUpdateHeight, 3000);
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(b => b.addEventListener('shown.bs.tab', () => setTimeout(iframeUpdateHeight, 100)));
        });
    </script>
</body>
</html>
